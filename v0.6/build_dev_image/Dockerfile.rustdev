################################################################################
# Rust Development Environment - Version 0.6.0
# Shared Dockerfile for all environments (dev, test, prod)
################################################################################
FROM ubuntu:22.04

ARG DEBIAN_FRONTEND=noninteractive
ENV TZ=Europe/Paris

################################################################################
# Install System Dependencies
################################################################################
RUN apt-get update && apt-get install -y \
    curl \
    wget \
    git \
    vim \
    nano \
    htop \
    tree \
    unzip \
    build-essential \
    pkg-config \
    libssl-dev \
    openssh-server \
    sudo \
    gnupg \
    && rm -rf /var/lib/apt/lists/*

################################################################################
# Install MongoDB Shell (mongosh)
################################################################################
RUN curl -fsSL https://www.mongodb.org/static/pgp/server-7.0.asc | \
    gpg -o /usr/share/keyrings/mongodb-server-7.0.gpg --dearmor && \
    echo "deb [ arch=amd64,arm64 signed-by=/usr/share/keyrings/mongodb-server-7.0.gpg ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/7.0 multiverse" | \
    tee /etc/apt/sources.list.d/mongodb-org-7.0.list && \
    apt-get update && \
    apt-get install -y mongodb-mongosh && \
    rm -rf /var/lib/apt/lists/*

################################################################################
# Install GitHub CLI
################################################################################
RUN curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | \
    gpg --dearmor -o /usr/share/keyrings/githubcli-archive-keyring.gpg && \
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | \
    tee /etc/apt/sources.list.d/github-cli.list > /dev/null && \
    apt-get update && \
    apt-get install -y gh && \
    rm -rf /var/lib/apt/lists/*

################################################################################
# User Configuration Arguments
################################################################################
ARG USERNAME=rustdev
ARG USER_UID=1026
ARG GROUPNAME=rustdevteam
ARG USER_GID=110
ARG GIT_USER_NAME=""
ARG GIT_USER_EMAIL=""

################################################################################
# Create Development User
################################################################################
RUN groupadd --gid ${USER_GID} ${GROUPNAME} || true && \
    useradd --uid ${USER_UID} --gid ${USER_GID} --shell /bin/bash -m ${USERNAME} || true && \
    usermod -aG sudo ${USERNAME} && \
    echo "${USERNAME} ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers.d/${USERNAME} && \
    chmod 0440 /etc/sudoers.d/${USERNAME}

WORKDIR /home/${USERNAME}

################################################################################
# Install Rust Toolchain
################################################################################
USER ${USERNAME}
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable && \
    . /home/${USERNAME}/.cargo/env && \
    /home/${USERNAME}/.cargo/bin/rustup default stable && \
    /home/${USERNAME}/.cargo/bin/cargo --version && \
    /home/${USERNAME}/.cargo/bin/rustc --version && \
    bash -c "echo '. /home/${USERNAME}/.cargo/env' >> /home/${USERNAME}/.bashrc" && \
    bash -c "echo '. /home/${USERNAME}/.cargo/env' >> /home/${USERNAME}/.profile"

ENV PATH="/home/${USERNAME}/.cargo/bin:${PATH}"

# Configure Rust cache directories and environment variables for optimal performance
RUN mkdir -p /home/${USERNAME}/.cargo/git/db && \
    mkdir -p /home/${USERNAME}/.cargo/registry/index && \
    mkdir -p /home/${USERNAME}/.cargo/registry/cache && \
    mkdir -p /home/${USERNAME}/.cargo/registry/src && \
    mkdir -p /home/${USERNAME}/.rustup

# Set Rust environment variables for optimal caching and performance
ENV CARGO_HOME=/home/${USERNAME}/.cargo
ENV RUSTUP_HOME=/home/${USERNAME}/.rustup
ENV CARGO_INCREMENTAL=1
ENV CARGO_BUILD_JOBS=4
ENV RUST_BACKTRACE=1

################################################################################
# Configure Git (if credentials provided)
################################################################################
USER ${USERNAME}
ARG GIT_USER_NAME
ARG GIT_USER_EMAIL
RUN if [ -n "${GIT_USER_NAME}" ] && [ -n "${GIT_USER_EMAIL}" ]; then \
        git config --global user.name "${GIT_USER_NAME}" && \
        git config --global user.email "${GIT_USER_EMAIL}"; \
    fi

################################################################################
# Configure SSH Server
################################################################################
USER root

RUN mkdir -p /var/run/sshd && \
    mkdir -p /home/${USERNAME}/.ssh && \
    chown ${USER_UID}:${USER_GID} /home/${USERNAME}/.ssh && \
    chmod 700 /home/${USERNAME}/.ssh

RUN sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin no/' /etc/ssh/sshd_config && \
    sed -i 's/#PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config && \
    sed -i 's/PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config && \
    sed -i 's/#PubkeyAuthentication yes/PubkeyAuthentication yes/' /etc/ssh/sshd_config && \
    sed -i 's/#AuthorizedKeysFile/AuthorizedKeysFile/' /etc/ssh/sshd_config && \
    sed 's@session\s*required\s*pam_loginuid.so@session optional pam_loginuid.so@g' -i /etc/pam.d/sshd

# Generate SSH host keys
RUN ssh-keygen -A

# Copy placeholder authorized_keys (will be overridden by environment-specific builds)
# Each environment should provide its own authorized_keys file
COPY authorized_keys.template /home/${USERNAME}/.ssh/authorized_keys

RUN chown ${USER_UID}:${USER_GID} /home/${USERNAME}/.ssh/authorized_keys && \
    chmod 600 /home/${USERNAME}/.ssh/authorized_keys

EXPOSE 22

################################################################################
# VS Code Extension Auto-Install Setup
################################################################################
USER root

# Copy extension installation script and devcontainer.json
COPY install_vscode_extensions.sh /home/${USERNAME}/install_vscode_extensions.sh
COPY devcontainer.json /home/${USERNAME}/.devcontainer.json

RUN chmod +x /home/${USERNAME}/install_vscode_extensions.sh && \
    chown ${USER_UID}:${USER_GID} /home/${USERNAME}/install_vscode_extensions.sh && \
    chown ${USER_UID}:${USER_GID} /home/${USERNAME}/.devcontainer.json

USER ${USERNAME}

# Add message to bashrc to prompt extension installation on first login
RUN echo '' >> /home/${USERNAME}/.bashrc && \
    echo '# VS Code Extensions Setup' >> /home/${USERNAME}/.bashrc && \
    echo 'if [ ! -f ~/.vscode_extensions_installed ]; then' >> /home/${USERNAME}/.bashrc && \
    echo '    echo ""' >> /home/${USERNAME}/.bashrc && \
    echo '    echo "========================================="' >> /home/${USERNAME}/.bashrc && \
    echo '    echo "VS Code Extensions Auto-Install"' >> /home/${USERNAME}/.bashrc && \
    echo '    echo "========================================="' >> /home/${USERNAME}/.bashrc && \
    echo '    echo ""' >> /home/${USERNAME}/.bashrc && \
    echo '    echo "Installing recommended VS Code extensions..."' >> /home/${USERNAME}/.bashrc && \
    echo '    if ~/install_vscode_extensions.sh 2>/dev/null; then' >> /home/${USERNAME}/.bashrc && \
    echo '        touch ~/.vscode_extensions_installed' >> /home/${USERNAME}/.bashrc && \
    echo '        echo ""' >> /home/${USERNAME}/.bashrc && \
    echo '        echo "âœ“ Extensions installed successfully!"' >> /home/${USERNAME}/.bashrc && \
    echo '        echo "  Please reload VS Code window: Ctrl+Shift+P -> Reload Window"' >> /home/${USERNAME}/.bashrc && \
    echo '        echo ""' >> /home/${USERNAME}/.bashrc && \
    echo '    else' >> /home/${USERNAME}/.bashrc && \
    echo '        echo ""' >> /home/${USERNAME}/.bashrc && \
    echo '        echo "Note: Extensions will be installed on next terminal session."' >> /home/${USERNAME}/.bashrc && \
    echo '        echo "Or run manually: ~/install_vscode_extensions.sh"' >> /home/${USERNAME}/.bashrc && \
    echo '        echo ""' >> /home/${USERNAME}/.bashrc && \
    echo '    fi' >> /home/${USERNAME}/.bashrc && \
    echo 'fi' >> /home/${USERNAME}/.bashrc

################################################################################
# Common Shell Aliases and Git Shortcuts
################################################################################
USER ${USERNAME}

# Add common shell aliases
RUN echo '' >> /home/${USERNAME}/.bashrc && \
    echo '# Common Shell Aliases' >> /home/${USERNAME}/.bashrc && \
    echo 'alias ll="ls -alF"' >> /home/${USERNAME}/.bashrc && \
    echo 'alias la="ls -A"' >> /home/${USERNAME}/.bashrc && \
    echo 'alias l="ls -CF"' >> /home/${USERNAME}/.bashrc && \
    echo 'alias ..="cd .."' >> /home/${USERNAME}/.bashrc && \
    echo 'alias ...="cd ../.."' >> /home/${USERNAME}/.bashrc && \
    echo 'alias grep="grep --color=auto"' >> /home/${USERNAME}/.bashrc && \
    echo 'alias fgrep="fgrep --color=auto"' >> /home/${USERNAME}/.bashrc && \
    echo 'alias egrep="egrep --color=auto"' >> /home/${USERNAME}/.bashrc

# Add Git aliases
RUN git config --global alias.st status && \
    git config --global alias.co checkout && \
    git config --global alias.br branch && \
    git config --global alias.ci commit && \
    git config --global alias.unstage 'reset HEAD --' && \
    git config --global alias.last 'log -1 HEAD' && \
    git config --global alias.visual '!gitk' && \
    git config --global alias.lg "log --graph --pretty=format:'%Cred%h%Creset -%C(yellow)%d%Creset %s %Cgreen(%cr) %C(bold blue)<%an>%Creset' --abbrev-commit"

# Add Cargo shortcuts
RUN echo '' >> /home/${USERNAME}/.bashrc && \
    echo '# Cargo Shortcuts' >> /home/${USERNAME}/.bashrc && \
    echo 'alias cb="cargo build"' >> /home/${USERNAME}/.bashrc && \
    echo 'alias cr="cargo run"' >> /home/${USERNAME}/.bashrc && \
    echo 'alias ct="cargo test"' >> /home/${USERNAME}/.bashrc && \
    echo 'alias cc="cargo check"' >> /home/${USERNAME}/.bashrc && \
    echo 'alias ccl="cargo clippy"' >> /home/${USERNAME}/.bashrc && \
    echo 'alias cf="cargo fmt"' >> /home/${USERNAME}/.bashrc && \
    echo 'alias cu="cargo update"' >> /home/${USERNAME}/.bashrc

################################################################################
# Development Service Aliases and Functions
################################################################################

# Add development service aliases and functions for Rust backend projects
RUN echo '' >> /home/${USERNAME}/.bashrc && \
    echo '# Development Service Aliases and Functions' >> /home/${USERNAME}/.bashrc && \
    echo 'alias dev-h="curl http://localhost:5645/health && echo \"\""' >> /home/${USERNAME}/.bashrc && \
    echo 'alias dev-v="curl http://localhost:5645/version && echo \"\""' >> /home/${USERNAME}/.bashrc && \
    echo 'alias dev-s="curl -X POST http://localhost:5645/shutdown && echo \"\""' >> /home/${USERNAME}/.bashrc && \
    echo 'alias dev-c="curl -X POST http://localhost:5645/clear?db && echo \"\""' >> /home/${USERNAME}/.bashrc && \
    echo '' >> /home/${USERNAME}/.bashrc && \
    echo 'dev-l() {' >> /home/${USERNAME}/.bashrc && \
    echo '    local port=${1:-5645}  # Default port 5645, or pass as argument' >> /home/${USERNAME}/.bashrc && \
    echo '    local project_dir=${2:-set_backend}  # Default project, or pass as argument' >> /home/${USERNAME}/.bashrc && \
    echo '    cd /workspace/$project_dir' >> /home/${USERNAME}/.bashrc && \
    echo '    ' >> /home/${USERNAME}/.bashrc && \
    echo '    if curl -s http://localhost:$port/health > /dev/null 2>&1; then' >> /home/${USERNAME}/.bashrc && \
    echo '        echo "Shutting down server on port $port..."' >> /home/${USERNAME}/.bashrc && \
    echo '        curl -X POST http://localhost:$port/shutdown 2>/dev/null' >> /home/${USERNAME}/.bashrc && \
    echo '        sleep 2' >> /home/${USERNAME}/.bashrc && \
    echo '    else' >> /home/${USERNAME}/.bashrc && \
    echo '        echo "Server not running on port $port"' >> /home/${USERNAME}/.bashrc && \
    echo '    fi' >> /home/${USERNAME}/.bashrc && \
    echo '    ' >> /home/${USERNAME}/.bashrc && \
    echo '    echo "Starting server..."' >> /home/${USERNAME}/.bashrc && \
    echo '    nohup cargo run > /dev/null 2>&1 &' >> /home/${USERNAME}/.bashrc && \
    echo '    echo "Server started (PID: $!)"' >> /home/${USERNAME}/.bashrc && \
    echo '    ' >> /home/${USERNAME}/.bashrc && \
    echo '    # Wait for server to be ready' >> /home/${USERNAME}/.bashrc && \
    echo '    for i in {1..10}; do' >> /home/${USERNAME}/.bashrc && \
    echo '        if curl -s http://localhost:$port/health > /dev/null 2>&1; then' >> /home/${USERNAME}/.bashrc && \
    echo '            echo "Server is ready on port $port"' >> /home/${USERNAME}/.bashrc && \
    echo '            return 0' >> /home/${USERNAME}/.bashrc && \
    echo '        fi' >> /home/${USERNAME}/.bashrc && \
    echo '        sleep 1' >> /home/${USERNAME}/.bashrc && \
    echo '    done' >> /home/${USERNAME}/.bashrc && \
    echo '    echo "Server failed to start within 10 seconds"' >> /home/${USERNAME}/.bashrc && \
    echo '}' >> /home/${USERNAME}/.bashrc

################################################################################
# Workspace Setup
################################################################################
USER root
RUN mkdir -p /workspace && chown ${USER_UID}:${USER_GID} /workspace

################################################################################
# Container Startup
################################################################################
CMD ["/usr/sbin/sshd", "-D"]